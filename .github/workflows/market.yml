name: main
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '*/5 * * * *' # Her 5 dakikada bir çalışır

jobs:
  build-and-run:
    runs-on: windows-latest

    steps:
      # Kodun repo'dan indirilmesi
      - name: Checkout Code
        uses: actions/checkout@v3

      # Java ortamının ayarlanması
      - name: Set up JDK 23
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '23'

      # Google Chrome'un belirli bir sürümünün kurulması
      - name: Check for Pending Reboot
        run: |
          if ((Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired' -ErrorAction SilentlyContinue)) {
            Write-Output "System reboot is required. Please restart the runner.";
            exit 1;
          }

      - name: Check Google Chrome Installation
        run: |
          if (google-chrome --version) {
            echo "Google Chrome is already installed.";
            exit 0;
          }

      - name: Install Google Chrome
        run: |
          choco install googlechrome --version=131.0.6778.140 --install-arguments="'/l*v c:\\GoogleChrome_msi_install.log'" -y

      - name: Verify Google Chrome Version
        run: google-chrome --version

      # MongoDB'nin kurulması
      - name: Install MongoDB
        run: |
          choco install mongodb -y
          net start MongoDB

      # Maven ile projenin derlenmesi
      - name: Build with Maven
        run: mvn clean install
        working-directory: ./demo

      # MongoDB'nin hazır olup olmadığını kontrol etme
      - name: Wait for MongoDB
        run: |
          for /l %i in (1, 1, 20) do (
            if netstat -an | find "27017" >nul 2>&1 (
              echo MongoDB is ready!
              exit 0
            )
            echo Waiting for MongoDB...
            timeout /t 5 >nul
          )
          echo MongoDB did not start in time.
          exit 1

      # Uygulamanın çalıştırılması
      - name: Run Application
        run: |
          java -Dwebdriver.chrome.driver=$(which chromedriver) \
               -Dwebdriver.chrome.whitelistedIps='' \
               -Dwebdriver.chrome.args='--no-sandbox --disable-dev-shm-usage --headless --disable-gpu --remote-debugging-port=9222' \
               -Dserver.port=8081 \
               -jar demo/target/demo-0.0.1-SNAPSHOT.jar